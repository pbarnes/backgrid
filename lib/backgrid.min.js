/*!
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors <wyuenho@gmail.com>
  Licensed under the MIT license.
*/
!function(a){"object"==typeof exports?module.exports=a(module.exports,require("underscore"),require("backbone")):"undefined"!=typeof _&&"undefined"!=typeof Backbone&&a(window,_,Backbone)}(function(a,b,c){"use strict";function d(a,b,c){var d=b-(a+"").length;d=0>d?0:d;for(var e="",f=0;d>f;f++)e+=c;return e+a}var e="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||e.trim()){e="["+e+"]";var f=new RegExp("^"+e+e+"*"),g=new RegExp(e+e+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(f,"").replace(g,"")}}var h=a.Backgrid={VERSION:"0.3.0",Extension:{},resolveNameToClass:function(a,c){if(b.isString(a)){var d=b.map(a.split("-"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")+c,e=h[d]||h.Extension[d];if(b.isUndefined(e))throw new ReferenceError("Class '"+d+"' not found");return e}return a},callByNeed:function(){var a=arguments[0];if(!b.isFunction(a))return a;var c=arguments[1],d=[].slice.call(arguments,2);return a.apply(c,d+""?d:void 0)}};b.extend(h,c.Events);var i=h.Command=function(a){b.extend(this,{altKey:!!a.altKey,"char":a["char"],charCode:a.charCode,ctrlKey:!!a.ctrlKey,key:a.key,keyCode:a.keyCode,locale:a.locale,location:a.location,metaKey:!!a.metaKey,repeat:!!a.repeat,shiftKey:!!a.shiftKey,which:a.which})};b.extend(i.prototype,{moveUp:function(){return 38==this.keyCode},moveDown:function(){return 40===this.keyCode},moveLeft:function(){return this.shiftKey&&9===this.keyCode},moveRight:function(){return!this.shiftKey&&9===this.keyCode},save:function(){return 13===this.keyCode},cancel:function(){return 27===this.keyCode},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var j=h.CellFormatter=function(){};b.extend(j.prototype,{fromRaw:function(a){return a},toRaw:function(a){return a}});var k=h.NumberFormatter=function(a){if(a=a?b.clone(a):{},b.extend(this,this.defaults,a),this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};k.prototype=new j,b.extend(k.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(a){if(b.isNull(a)||b.isUndefined(a))return"";a=a.toFixed(~~this.decimals);var c=a.split("."),d=c[0],e=c[1]?(this.decimalSeparator||".")+c[1]:"";return d.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+e},toRaw:function(a){if(a=a.trim(),""===a)return null;for(var c="",d=a.split(this.orderSeparator),e=0;e<d.length;e++)c+=d[e];var f=c.split(this.decimalSeparator);c="";for(var e=0;e<f.length;e++)c=c+f[e]+".";"."===c[c.length-1]&&(c=c.slice(0,c.length-1));var g=1*(1*c).toFixed(~~this.decimals);return b.isNumber(g)&&!b.isNaN(g)?g:void 0}});var l=h.DatetimeFormatter=function(a){if(a=a?b.clone(a):{},b.extend(this,this.defaults,a),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};l.prototype=new j,b.extend(l.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(a,c){if(""===(a+"").trim())return null;var e,f=null;if(b.isNumber(a)){var g=new Date(a);e=d(g.getUTCFullYear(),4,0)+"-"+d(g.getUTCMonth()+1,2,0)+"-"+d(g.getUTCDate(),2,0),f=d(g.getUTCHours(),2,0)+":"+d(g.getUTCMinutes(),2,0)+":"+d(g.getUTCSeconds(),2,0)}else{a=a.trim();var h=a.split(this.ISO_SPLITTER_RE)||[];e=this.DATE_RE.test(h[0])?h[0]:"",f=e&&h[1]?h[1]:this.TIME_RE.test(h[0])?h[0]:""}var i=this.DATE_RE.exec(e)||[],j=this.TIME_RE.exec(f)||[];if(c){if(this.includeDate&&b.isUndefined(i[0]))return;if(this.includeTime&&b.isUndefined(j[0]))return;if(!this.includeDate&&e)return;if(!this.includeTime&&f)return}var g=new Date(Date.UTC(1*i[1]||0,1*i[2]-1||0,1*i[3]||0,1*j[1]||null,1*j[2]||null,1*j[3]||null,1*j[5]||null)),k="";return this.includeDate&&(k=d(g.getUTCFullYear(),4,0)+"-"+d(g.getUTCMonth()+1,2,0)+"-"+d(g.getUTCDate(),2,0)),this.includeTime&&(k=k+(this.includeDate?"T":"")+d(g.getUTCHours(),2,0)+":"+d(g.getUTCMinutes(),2,0)+":"+d(g.getUTCSeconds(),2,0),this.includeMilli&&(k=k+"."+d(g.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(k+="Z"),k},fromRaw:function(a){return b.isNull(a)||b.isUndefined(a)?"":this._convert(a)},toRaw:function(a){return this._convert(a,!0)}});var m=h.StringFormatter=function(){};m.prototype=new j,b.extend(m.prototype,{fromRaw:function(a){return b.isUndefined(a)||b.isNull(a)?"":a+""}});var n=h.EmailFormatter=function(){};n.prototype=new j,b.extend(n.prototype,{toRaw:function(a){var c=a.trim().split("@");return 2===c.length&&b.all(c)?a:void 0}});var o=h.SelectFormatter=function(){};o.prototype=new j,b.extend(o.prototype,{fromRaw:function(a){return b.isArray(a)?a:null!=a?[a]:[]}});var p=h.CellEditor=c.View.extend({initialize:function(a){this.formatter=a.formatter,this.column=a.column,this.column instanceof x||(this.column=new x(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(a,b){return(null==b||b.get("name")==this.column.get("name"))&&this.$el.focus(),this}}),q=h.InputCellEditor=p.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(a){p.prototype.initialize.apply(this,arguments),a.placeholder&&this.$el.attr("placeholder",a.placeholder)},render:function(){var a=this.model;return this.$el.val(this.formatter.fromRaw(a.get(this.column.get("name"))),a),this},saveOrCancel:function(a){var c=this.formatter,d=this.model,e=this.column,f=new i(a),g="blur"===a.type;if(f.moveUp()||f.moveDown()||f.moveLeft()||f.moveRight()||f.save()||g){a.preventDefault(),a.stopPropagation();var h=this.$el.val(),j=c.toRaw(h,d);b.isUndefined(j)?d.trigger("backgrid:error",d,e,h):(d.set(e.get("name"),j),d.trigger("backgrid:edited",d,e,f))}else f.cancel()&&(a.stopPropagation(),d.trigger("backgrid:edited",d,e,f))},postRender:function(a,b){if(null==b||b.get("name")==this.column.get("name"))if("right"===this.$el.css("text-align")){var c=this.$el.val();this.$el.focus().val(null).val(c)}else this.$el.focus();return this}}),r=h.Cell=c.View.extend({tagName:"td",formatter:new j,editor:q,events:{click:"enterEditMode"},initialize:function(a){this.column=a.column,this.column instanceof x||(this.column=new x(this.column));var b=this.column,c=this.model,d=this.$el;this.formatter=h.resolveNameToClass(b.get("formatter")||this.formatter,"Formatter"),this.editor=h.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(c,"change:"+b.get("name"),function(){d.hasClass("editor")||this.render()}),this.listenTo(c,"backgrid:error",this.renderError),this.listenTo(b,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var c in b)b.hasOwnProperty(c)&&d.toggleClass(c,b[c])}),b.get("editable")&&d.addClass("editable"),b.get("sortable")&&d.addClass("sortable"),b.get("renderable")&&d.addClass("renderable")},render:function(){this.$el.empty();var a=this.model;return this.$el.text(this.formatter.fromRaw(a.get(this.column.get("name"))),a),this.delegateEvents(),this},enterEditMode:function(){var a=this.model,b=this.column,c=h.callByNeed(b.editable(),b,a);c&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),a.trigger("backgrid:edit",a,b,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),a.trigger("backgrid:editing",a,b,this,this.currentEditor))},renderError:function(a,b){(null==b||b.get("name")==this.column.get("name"))&&this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),c.View.prototype.remove.apply(this,arguments)}}),s=h.StringCell=r.extend({className:"string-cell",formatter:new m});h.UriCell=r.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(a){r.prototype.initialize.apply(this,arguments),this.title=a.title||this.title,this.target=a.target||this.target},render:function(){this.$el.empty();var a=this.model.get(this.column.get("name")),b=this.formatter.fromRaw(a,this.model);return this.$el.append($("<a>",{tabIndex:-1,href:a,title:this.title||b,target:this.target}).text(b)),this.delegateEvents(),this}}),h.EmailCell=s.extend({className:"email-cell",formatter:new n,render:function(){this.$el.empty();var a=this.model,b=this.formatter.fromRaw(a.get(this.column.get("name")),a);return this.$el.append($("<a>",{tabIndex:-1,href:"mailto:"+b,title:b}).text(b)),this.delegateEvents(),this}});var t=h.NumberCell=r.extend({className:"number-cell",decimals:k.prototype.defaults.decimals,decimalSeparator:k.prototype.defaults.decimalSeparator,orderSeparator:k.prototype.defaults.orderSeparator,formatter:k,initialize:function(){r.prototype.initialize.apply(this,arguments),this.formatter.fromRaw||this.formatter.toRaw||(this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator}))}});h.IntegerCell=t.extend({className:"integer-cell",decimals:0});var u=h.DatetimeCell=r.extend({className:"datetime-cell",includeDate:l.prototype.defaults.includeDate,includeTime:l.prototype.defaults.includeTime,includeMilli:l.prototype.defaults.includeMilli,formatter:l,initialize:function(){r.prototype.initialize.apply(this,arguments),this.formatter.fromRaw||this.formatter.toRaw||(this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli}));var a=this.includeDate?"YYYY-MM-DD":"";a+=this.includeDate&&this.includeTime?"T":"",a+=this.includeTime?"HH:mm:ss":"",a+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:b.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:a})})}});h.DateCell=u.extend({className:"date-cell",includeTime:!1}),h.TimeCell=u.extend({className:"time-cell",includeDate:!1});var v=h.BooleanCellEditor=p.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var a=this.model,b=this.formatter.fromRaw(a.get(this.column.get("name")),a);return this.$el.prop("checked",b),this},enterOrExitEditMode:function(a){if(!this.mouseDown){var b=this.model;b.trigger("backgrid:edited",b,this.column,new i(a))}},saveOrCancel:function(a){var b=this.model,c=this.column,d=this.formatter,e=new i(a);if(e.passThru()&&"change"!=a.type)return!0;e.cancel()&&(a.stopPropagation(),b.trigger("backgrid:edited",b,c,e));var f=this.$el;if(e.save()||e.moveLeft()||e.moveRight()||e.moveUp()||e.moveDown()){a.preventDefault(),a.stopPropagation();var g=d.toRaw(f.prop("checked"),b);b.set(c.get("name"),g),b.trigger("backgrid:edited",b,c,e)}else if("change"==a.type){var g=d.toRaw(f.prop("checked"),b);b.set(c.get("name"),g),f.focus()}}});h.BooleanCell=r.extend({className:"boolean-cell",editor:v,events:{click:"enterEditMode"},render:function(){this.$el.empty();var a=this.model;return this.$el.append($("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(a.get(this.column.get("name")),a)})),this.delegateEvents(),this}});var w=h.SelectCellEditor=p.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:b.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>'),setOptionValues:function(a){this.optionValues=a},setMultiple:function(a){this.multiple=a,this.$el.prop("multiple",a)},_renderOptions:function(a,b){for(var c="",d=0;d<a.length;d++)c+=this.template({text:a[d][0],value:a[d][1],selected:b.indexOf(a[d][1])>-1});return c},render:function(){this.$el.empty();var a=b.result(this,"optionValues"),c=this.model,d=this.formatter.fromRaw(c.get(this.column.get("name")),c);if(!b.isArray(a))throw new TypeError("optionValues must be an array");for(var e=null,f=null,e=null,g=null,h=null,i=0;i<a.length;i++){var e=a[i];if(b.isArray(e))f=e[0],e=e[1],this.$el.append(this.template({text:f,value:e,selected:d.indexOf(e)>-1}));else{if(!b.isObject(e))throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");g=e.name,h=$("<optgroup></optgroup>",{label:g}),h.append(this._renderOptions(e.values,d)),this.$el.append(h)}}return this.delegateEvents(),this},save:function(a){var b=this.model,c=this.column;b.set(c.get("name"),this.formatter.toRaw(this.$el.val(),b)),b.trigger("backgrid:edited",b,c,new i(a))},close:function(a){var b=this.model,c=this.column,d=new i(a);d.cancel()?(a.stopPropagation(),b.trigger("backgrid:edited",b,c,new i(a))):(d.save()||d.moveLeft()||d.moveRight()||d.moveUp()||d.moveDown()||"blur"==a.type)&&(a.preventDefault(),a.stopPropagation(),"blur"==a.type&&1===this.$el.find("option").length&&b.set(c.get("name"),this.formatter.toRaw(this.$el.val(),b)),b.trigger("backgrid:edited",b,c,new i(a)))}});h.SelectCell=r.extend({className:"select-cell",editor:w,multiple:!1,formatter:new o,optionValues:void 0,delimiter:", ",initialize:function(){r.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"backgrid:edit",function(a,b,c,d){b.get("name")==this.column.get("name")&&(d.setOptionValues(this.optionValues),d.setMultiple(this.multiple))})},render:function(){this.$el.empty();var a=this.optionValues,c=this.model,d=this.formatter.fromRaw(c.get(this.column.get("name")),c),e=[];try{if(!b.isArray(a)||b.isEmpty(a))throw new TypeError;for(var f=0;f<d.length;f++)for(var g=d[f],h=0;h<a.length;h++){var i=a[h];if(b.isArray(i)){var j=i[0],i=i[1];i==g&&e.push(j)}else{if(!b.isObject(i))throw new TypeError;for(var k=i.values,l=0;l<k.length;l++){var m=k[l];m[1]==g&&e.push(m[0])}}}this.$el.append(e.join(this.delimiter))}catch(n){if(n instanceof TypeError)throw new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw n}return this.delegateEvents(),this}});var x=h.Column=c.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,sortValue:void 0,cell:void 0,headerCell:void 0},initialize:function(){this.has("label")||this.set({label:this.get("name")},{silent:!0});var a=h.resolveNameToClass(this.get("headerCell"),"HeaderCell"),b=h.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:b,headerCell:a},{silent:!0})},sortValue:function(){var a=this.get("sortValue");return b.isString(a)?this[a]:b.isFunction(a)?a:function(a,b){return a.get(b)}}});b.each(["sortable","renderable","editable"],function(a){x.prototype[a]=function(){var c=this.get(a);return b.isString(c)?this[c]:!!c}});var y=h.Columns=c.Collection.extend({model:x}),z=h.Row=c.View.extend({tagName:"tr",initialize:function(a){var b=this.columns=a.columns;b instanceof c.Collection||(b=this.columns=new y(b));for(var d=this.cells=[],e=0;e<b.length;e++)d.push(this.makeCell(b.at(e),a));this.listenTo(b,"add",function(b,c){var e=c.indexOf(b),f=this.makeCell(b,a);d.splice(e,0,f);var g=this.$el;0===e?g.prepend(f.render().$el):e===c.length-1?g.append(f.render().$el):g.children().eq(e).before(f.render().$el)}),this.listenTo(b,"remove",function(a,b,c){d[c.index].remove(),d.splice(c.index,1)})},makeCell:function(a){return new(a.get("cell"))({column:a,model:this.model})},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.cells.length;b++)a.appendChild(this.cells[b].render().el);return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.cells.length;a++){var b=this.cells[a];b.remove.apply(b,arguments)}return c.View.prototype.remove.apply(this,arguments)}}),A=h.EmptyRow=c.View.extend({tagName:"tr",emptyText:null,initialize:function(a){this.emptyText=a.emptyText,this.columns=a.columns},render:function(){this.$el.empty();var a=document.createElement("td");return a.setAttribute("colspan",this.columns.length),a.textContent=this.emptyText,this.el.setAttribute("class","empty"),this.el.appendChild(a),this}}),B=h.HeaderCell=c.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(a){this.column=a.column,this.column instanceof x||(this.column=new x(this.column)),this.listenTo(this.collection,"backgrid:sort",this._resetCellDirection);var b=this.column,c=this.$el;this.listenTo(b,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var d in b)b.hasOwnProperty(d)&&c.toggleClass(d,b[d])}),b.get("editable")&&c.addClass("editable"),b.get("sortable")&&c.addClass("sortable"),b.get("renderable")&&c.addClass("renderable")},direction:function(a){return arguments.length&&(this._direction&&this.$el.removeClass(this._direction),a&&this.$el.addClass(a),this._direction=a),this._direction},_resetCellDirection:function(a,b,c,d){d==this.collection&&(a!==this.column?this.direction(null):this.direction(b))},onClick:function(a){function b(a,b){"ascending"===a.direction()?a.sort(b,"descending"):"descending"===a.direction()?a.sort(b,null):a.sort(b,"ascending")}function c(a,b){"ascending"===a.direction()?a.sort(b,"descending"):a.sort(b,"ascending")}a.preventDefault();var d=this.column,e=h.callByNeed(d.sortable(),d,this.model);if(e){var f=d.get("sortType");"toggle"===f?c(this,d):b(this,d)}},sort:function(a,b){var d,e=this.collection;d="ascending"===b?-1:"descending"===b?1:null;var f=this.makeComparator(a.get("name"),d,d?a.sortValue():function(a){return a.cid});c.PageableCollection&&e instanceof c.PageableCollection?(e.setSorting(d&&a.get("name"),d,{sortValue:a.sortValue()}),"client"==e.mode?(null==e.fullCollection.comparator&&(e.fullCollection.comparator=f),e.fullCollection.sort()):e.fetch({reset:!0})):(e.comparator=f,e.sort()),this.collection.trigger("backgrid:sort",a,b,f,this.collection)},makeComparator:function(a,b,c){return function(d,e){var f,g=c(d,a),h=c(e,a);return 1===b&&(f=g,g=h,h=f),g===h?0:h>g?-1:1}},render:function(){this.$el.empty();var a=$("<a>").text(this.column.get("label")),b=h.callByNeed(this.column.sortable(),this.column,this.model);return b&&a.append("<b class='sort-caret'></b>"),this.$el.append(a),this.delegateEvents(),this}});h.HeaderRow=h.Row.extend({requiredOptions:["columns","collection"],initialize:function(){h.Row.prototype.initialize.apply(this,arguments)},makeCell:function(a,b){var c=a.get("headerCell")||b.headerCell||B;return c=new c({column:a,collection:this.collection})}});var C=h.Header=c.View.extend({tagName:"thead",initialize:function(a){this.columns=a.columns,this.columns instanceof c.Collection||(this.columns=new y(this.columns)),this.row=new h.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),c.View.prototype.remove.apply(this,arguments)}}),D=h.Body=c.View.extend({tagName:"tbody",initialize:function(a){this.columns=a.columns,this.columns instanceof c.Collection||(this.columns=new y(this.columns)),this.row=a.row||z,this.rows=this.collection.map(function(a){var b=new this.row({columns:this.columns,model:a});return b},this),this.emptyText=a.emptyText,this._unshiftEmptyRowMayBe();var b=this.collection;this.listenTo(b,"add",this.insertRow),this.listenTo(b,"remove",this.removeRow),this.listenTo(b,"sort",this.refresh),this.listenTo(b,"reset",this.refresh),this.listenTo(b,"backgrid:edited",this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){0===this.rows.length&&null!=this.emptyText&&this.rows.unshift(new A({emptyText:this.emptyText,columns:this.columns}))},insertRow:function(a,d,e){if(this.rows[0]instanceof A&&this.rows.pop().remove(),!(d instanceof c.Collection||e))return this.collection.add(a,e=d),void 0;e=b.extend({render:!0},e||{});var f=new this.row({columns:this.columns,model:a}),g=d.indexOf(a);this.rows.splice(g,0,f);var h=this.$el,i=h.children(),j=f.render().$el;e.render&&(g>=i.length?h.append(j):i.eq(g).before(j))},removeRow:function(a,c,d){return d?((b.isUndefined(d.render)||d.render)&&this.rows[d.index].remove(),this.rows.splice(d.index,1),this._unshiftEmptyRowMayBe(),void 0):(this.collection.remove(a,d=c),this._unshiftEmptyRowMayBe(),void 0)},refresh:function(){for(var a=0;a<this.rows.length;a++)this.rows[a].remove();return this.rows=this.collection.map(function(a){var b=new this.row({columns:this.columns,model:a});return b},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.rows.length;b++){var c=this.rows[b];a.appendChild(c.render().el)}return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.rows.length;a++){var b=this.rows[a];b.remove.apply(b,arguments)}return c.View.prototype.remove.apply(this,arguments)},moveToNextCell:function(a,b,c){var d,e,f,g=this.collection.indexOf(a),i=this.columns.indexOf(b);if(this.rows[g].cells[i].exitEditMode(),c.moveUp()||c.moveDown()||c.moveLeft()||c.moveRight()||c.save()){var j=this.columns.length,k=j*this.collection.length;if(c.moveUp()||c.moveDown()){var l=this.rows[g+(c.moveUp()?-1:1)];l&&(d=l.cells[i],h.callByNeed(d.column.editable(),d.column,a)&&d.enterEditMode())}else if(c.moveLeft()||c.moveRight())for(var m=c.moveRight(),n=g*j+i+(m?1:-1);n>=0&&k>n;m?n++:n--){var o=~~(n/j),p=n-o*j;if(d=this.rows[o].cells[p],e=h.callByNeed(d.column.renderable(),d.column,d.model),f=h.callByNeed(d.column.editable(),d.column,a),e&&f){d.enterEditMode();break}}}}});h.Footer=c.View.extend({tagName:"tfoot",initialize:function(a){this.columns=a.columns,this.columns instanceof c.Collection||(this.columns=new h.Columns(this.columns))}}),h.Grid=c.View.extend({tagName:"table",className:"backgrid",header:C,body:D,footer:null,initialize:function(a){a.columns instanceof c.Collection||(a.columns=new y(a.columns)),this.columns=a.columns;var d=b.omit(a,["el","id","attributes","className","tagName","events"]);this.header=a.header||this.header,this.header=new this.header(d),this.body=a.body||this.body,this.body=new this.body(d),this.footer=a.footer||this.footer,this.footer&&(this.footer=new this.footer(d)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(d),this.body=new(this.body.remove().constructor)(d),this.footer&&(this.footer=new(this.footer.remove().constructor)(d)),this.render()})},insertRow:function(a,b,c){return this.body.insertRow(a,b,c)},removeRow:function(a,b,c){return this.body.removeRow(a,b,c)},insertColumn:function(a,b){return b=b||{render:!0},this.columns.add(a,b),this},removeColumn:function(a,b){return this.columns.remove(a,b),this},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),c.View.prototype.remove.apply(this,arguments)}})});